server {
	listen 80;
	listen [::]:80;
	
	server_name octopi.octoprint.org;
	server_tokens off;

	access_log /var/log/nginx/octopi.octoprint.org/access.log;
	error_log /var/log/nginx/octopi.octoprint.org/error.log;

	return 301 https://$server_name$request_uri;
}

server {
	listen 443 ssl;
	listen [::]:443 ssl;

	server_name octopi.octoprint.org;
	server_tokens off;

	access_log /var/log/nginx/octopi.octoprint.org/access.log;
	error_log /var/log/nginx/octopi.octoprint.org/error.log;

	gzip on;
	gzip_vary on;
	gzip_min_length 1000;
	gzip_comp_level 5;
	gzip_types application/json text/css application/x-javascript application/javascript;

	keepalive_timeout 65;

	ssl_certificate /etc/letsencrypt/live/octopi.octoprint.org/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/octopi.octoprint.org/privkey.pem;
	include hardened_ssl.conf;

	root /var/www/octopi.octoprint.org/html;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

 	set $latest_image "https://github.com/guysoft/OctoPi/releases/download/0.18.0/octopi-buster-armhf-lite-0.18.0.zip";
	set $next_image "https://github.com/guysoft/OctoPi/releases/download/0.18.0/octopi-buster-armhf-lite-0.18.0.zip";

	location / {
		return 301 https://octoprint.org/download/;
	}

	location /robots.txt {
		return 200 "User-agent: *\nDisallow: /download/\nDisallow: /latest\nDisallow: /latest.md5\nDisallow: /previous\nDisallow: /previous.md5\nDisallow: /next\nDisallow: /next.md5";
	}

	location /rpi-imager.json {
		proxy_pass https://octoprint.org/files/rpi-imager.json;
	}

	location /rpi-imager.png {
		proxy_pass https://raw.githubusercontent.com/guysoft/OctoPi/devel/media/rpi-imager-OctoPi.png;
	}

	location /latest {
		return 302 $latest_image;
	}

	location /latest.sha256 {
		return 302 $latest_image.sha256;
	}

	location /next {
		return 302 $next_image;
	}
	
	location /next.sha256 {
		return 302 $next_image.sha256;
	}

	location /.well-known/acme-challenge/ {
		default_type "text/plain";
		root /usr/share/nginx/html/acme;
	}
}


